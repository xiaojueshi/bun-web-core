name: Bun CI & Release

on:
  push:
    branches:
      - main

jobs:
  build-test-release:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Bun ç¯å¢ƒ
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: å®‰è£…ä¾èµ–
        run: bun install

      - name: ç±»å‹æ£€æŸ¥
        run: bun run type-check

      - name: è¿è¡Œæµ‹è¯•
        run: bun test

      - name: æ„å»ºé¡¹ç›®
        run: bun run build

      - name: æ£€æŸ¥ package.json ç‰ˆæœ¬å˜æ›´
        id: version_check
        run: |
          git fetch origin --tags
          PREV_VERSION=$(git tag --sort=-v:refname | head -n1 | sed 's/^v//')
          CUR_VERSION=$(jq -r .version package.json)
          echo "PREV_VERSION=$PREV_VERSION" >> $GITHUB_ENV
          echo "CUR_VERSION=$CUR_VERSION" >> $GITHUB_ENV
          if [ "$PREV_VERSION" = "$CUR_VERSION" ]; then
            echo "ç‰ˆæœ¬æœªå˜æ›´ï¼Œè·³è¿‡å‘ç‰ˆã€‚"
            echo "publish=false" >> $GITHUB_OUTPUT
          else
            echo "æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬: $CUR_VERSION"
            echo "publish=true" >> $GITHUB_OUTPUT
          fi

      - name: è‡ªåŠ¨ç”Ÿæˆ CHANGELOG å¹¶æäº¤ tag
        if: steps.version_check.outputs.publish == 'true'
        uses: changesets/action@v1
        with:
          publish: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒåˆ° npm
        if: steps.version_check.outputs.publish == 'true'
        run: bunx changeset publish
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: å‘å¸ƒå®Œæˆæç¤º
        if: steps.version_check.outputs.publish == 'true'
        run: echo "ğŸ‰ æ–°ç‰ˆæœ¬ $CUR_VERSION å·²è‡ªåŠ¨å‘å¸ƒåˆ° npmï¼"
# æ³¨æ„äº‹é¡¹ï¼š
# 1. ä½ éœ€è¦åœ¨ GitHub ä»“åº“çš„ Settings > Secrets > Actions ä¸­æ·»åŠ  NPM_TOKENï¼Œ
#    è¯¥ token éœ€æ‹¥æœ‰ npm å‘å¸ƒæƒé™ï¼ˆnpm token create --read-only falseï¼‰ã€‚
# 2. æœ¬æµç¨‹ä¾èµ– changesets å·¥å…·è‡ªåŠ¨ç”Ÿæˆ changelog å’Œ tagï¼Œ
#    è¯·ç¡®ä¿å·²åœ¨é¡¹ç›®ä¸­å®‰è£… changesetsï¼ˆbun add -D @changesets/cliï¼‰ï¼Œå¹¶åˆå§‹åŒ–ï¼ˆbunx changeset initï¼‰ã€‚
# 3. è‹¥é¦–æ¬¡ä½¿ç”¨ changesetsï¼Œå»ºè®®å…ˆæ‰‹åŠ¨åˆå§‹åŒ–å¹¶ç”Ÿæˆä¸€æ¬¡ changelogã€‚
