name: Bun CI & Release

on:
  push:
    branches:
      - main

jobs:
  build-test-release:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Bun ç¯å¢ƒ
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: å®‰è£…ä¾èµ–
        run: bun install

      - name: ç±»å‹æ£€æŸ¥
        run: bun run type-check

      - name: è¿è¡Œæµ‹è¯•
        run: bun test

      - name: æ„å»ºé¡¹ç›®
        run: bun run build

      - name: è¯»å– package.json ç‰ˆæœ¬
        id: pkg
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

      - name: æ‰“ tag å¹¶åˆ›å»º GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.pkg.outputs.version }}
          release_name: Release v${{ steps.pkg.outputs.version }}
          draft: false
          prerelease: false

      - name: å‘å¸ƒåˆ° npm
        run: npm publish --access public
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: å‘å¸ƒå®Œæˆæç¤º
        run: echo "ğŸ‰ æ–°ç‰ˆæœ¬å·²è‡ªåŠ¨å‘å¸ƒåˆ° npmï¼"
# æ³¨æ„äº‹é¡¹ï¼š
# 1. ä½ éœ€è¦åœ¨ GitHub ä»“åº“çš„ Settings > Secrets > Actions ä¸­æ·»åŠ  NPM_TOKENï¼Œ
#    è¯¥ token éœ€æ‹¥æœ‰ npm å‘å¸ƒæƒé™ï¼ˆnpm token create --read-only falseï¼‰ã€‚
# 2. .npmrc æ–‡ä»¶éœ€é…ç½® registry å’Œ token å ä½ç¬¦ã€‚
